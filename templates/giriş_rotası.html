@app.route("/giris", methods=["GET", "POST"])
def giris():
    error = None
    users = load_users()

    if request.method == "POST":
        email = request.form.get("email", "").strip().lower()
        password = request.form.get("password", "").strip()
        role = request.form.get("role", "").strip().lower().replace("Ä±", "i")  # TÃ¼rkÃ§e karakter dÃ¶nÃ¼ÅŸÃ¼mÃ¼

        print(f"ğŸ›  GiriÅŸ yapan kullanÄ±cÄ±: {email}, Role: {role}")  # Debugging iÃ§in

        # **EÅŸleÅŸen kullanÄ±cÄ±larÄ± bul**
        matched_users = [u for u in users if u["email"] == email and u["password"] == password]

        if not matched_users:
            error = "HatalÄ± giriÅŸ bilgileri! LÃ¼tfen tekrar deneyin."
            return render_template("giris.html", error=error)

        # **DoÄŸru rolÃ¼ olan kullanÄ±cÄ±yÄ± bul**
        user = next((u for u in matched_users if u["role"].strip().lower().replace("Ä±", "i") == role), None)

        if not user:
            error = "YanlÄ±ÅŸ rol seÃ§imi! LÃ¼tfen doÄŸru rolÃ¼ seÃ§in."
            print(f"âŒ YanlÄ±ÅŸ rol seÃ§ildi! KayÄ±tlÄ± roller: {[u['role'] for u in matched_users]}, SeÃ§ilen rol: {role}")
            return render_template("giris.html", error=error)

        # **BaÅŸarÄ±lÄ± giriÅŸ**
        session['logged_in'] = True
        session['email'] = user["email"]
        session['role'] = user["role"]
        session['ad'] = user["ad"]

        print(f"âœ… BaÅŸarÄ±lÄ± giriÅŸ: {email}, Rol: {user['role']}")

        # **GiriÅŸ sonrasÄ± yÃ¶nlendirme**
        if user["role"] == "hasta":
            return redirect(url_for("ana_sayfa"))
        elif user["role"] == "saglik_calisani":
            return redirect(url_for("saglik_calisani"))

    return render_template("giris.html", error=error)